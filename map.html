<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Last-Words ‚Äî Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
    body {
        margin: 0;
        padding: 0;
        background: #000;
        font-family: Inter, Arial, sans-serif;
        overflow: hidden;
        color: #f5f5f5;
    }

    #container {
        display: flex;
        height: 100vh;
        width: 100vw;
    }

    #map {
        flex: 1;
        height: 100%;
        z-index: 1;
    }

    /* PANEL */
    #panel {
        width: 350px;
        background: #0d0d0d;
        padding: 25px;
        box-shadow: -2px 0 20px rgba(0,0,0,0.7);
        z-index: 9999;
        overflow-y: auto;
    }

    h2 {
        font-weight: 400;
        margin-bottom: 20px;
    }

    label {
        font-size: 13px;
        color: #bbb;
    }

    input, textarea {
        width: 100%;
        padding: 10px;
        background: #111;
        border: 1px solid #333;
        color: white;
        border-radius: 8px;
        margin-top: 6px;
        margin-bottom: 14px;
        font-size: 14px;
    }

    textarea {
        height: 110px;
        resize: none;
    }

    button {
        width: 100%;
        padding: 12px;
        background: white;
        border-radius: 20px;
        border: none;
        margin-top: 10px;
        font-weight: bold;
        cursor: pointer;
    }

    .paypal-container {
        margin-top: 10px;
    }

    /* Loader */
    #loader {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.65);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        font-size: 22px;
        backdrop-filter: blur(4px);
    }

    /* Success */
    #successBox {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #0d0d0d;
        padding: 25px 40px;
        border-radius: 12px;
        display: none;
        text-align: center;
        box-shadow: 0 0 20px rgba(255,255,255,0.15);
        z-index: 10001;
    }

    /* üìç MARKER */
    .custom-marker {
        font-size: 22px;
        filter: drop-shadow(0 0 6px rgba(255,255,255,0.35));
        transition: transform 0.2s ease;
    }

    .custom-marker:hover {
        transform: scale(1.2);
    }

    /* POPUP */
    .leaflet-popup-content-wrapper,
    .leaflet-popup-tip {
        background: #111;
        color: #f5f5f5;
        box-shadow: 0 0 20px rgba(0,0,0,0.7);
        border-radius: 10px;
    }
</style>
</head>

<body>

<div id="container">
    <div id="map"></div>

    <div id="panel">
        <h2>Leave your words</h2>

        <label>Name</label>
        <input id="name" type="text">

        <label>Message</label>
        <textarea id="message"></textarea>

        <label>Country</label>
        <input id="country" type="text">

        <p style="font-size:12px;color:#888;">
            Click on the map to choose the place.
        </p>

        <div id="paypal-button-container" class="paypal-container"></div>

        <label>Have a special code?</label>
        <input id="code-input" placeholder="Enter your code">
        <button onclick="useCode()">Use code</button>

        <button onclick="publishMessage()">Publish message</button>
    </div>
</div>

<div id="loader">Publishing your message‚Ä¶</div>
<div id="successBox">‚ú® Your message is now on the map ‚ú®</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.paypal.com/sdk/js?client-id=sb&currency=USD"></script>

<script>
/* ============================
   MAP
============================ */
let map = L.map('map').setView([20, 0], 3);

L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
  { maxZoom: 19 }
).addTo(map);

let marker = null;

map.on("click", function (e) {
    if (marker) map.removeLayer(marker);

    marker = L.marker(e.latlng, {
        icon: L.divIcon({
            className: "custom-marker",
            html: "üìç",
            iconSize: [24, 24],
            iconAnchor: [12, 24]
        })
    }).addTo(map);

    window.selectedLat = e.latlng.lat;
    window.selectedLng = e.latlng.lng;
});

/* ============================
   UI
============================ */
function showLoader() {
    loader.style.display = "flex";
}

function hideLoader() {
    loader.style.display = "none";
}

function showSuccess() {
    successBox.style.display = "block";
    setTimeout(() => successBox.style.display = "none", 2500);
}

/* ============================
   PAYPAL
============================ */
paypal.Buttons({
    createOrder: (data, actions) => actions.order.create({
        purchase_units: [{ amount: { value: "10.00" } }]
    }),
    onApprove: (data, actions) =>
        fetch("https://last-words-backend.onrender.com/payment-success", {
            method: "POST"
        })
        .then(r => r.json())
        .then(data => {
            localStorage.setItem("message_token", data.token);
            alert("Payment successful. You can now publish your message.");
        })
}).render("#paypal-button-container");

/* ============================
   USE CODE
============================ */
async function useCode() {
    showLoader();

    const res = await fetch("https://last-words-backend.onrender.com/use-free-code", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code: code-input.value })
    });

    const data = await res.json();
    hideLoader();

    if (!res.ok) return alert(data.detail);

    localStorage.setItem("message_token", data.token);
    showSuccess();
}

/* ============================
   PUBLISH
============================ */
async function publishMessage() {
    const token = localStorage.getItem("message_token");
    if (!token) return alert("Please pay or use a code first.");

    showLoader();

    try {
        const res = await fetch("https://last-words-backend.onrender.com/send-message", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "x-payment-token": token
            },
            body: JSON.stringify({
                name: name.value,
                message: message.value,
                country: country.value,
                emoji: "üìç",
                latitude: window.selectedLat,
                longitude: window.selectedLng
            })
        });

        const data = await res.json();
        hideLoader();

        if (!res.ok) return alert(data.detail);

        localStorage.removeItem("message_token");
        showSuccess();

    } catch {
        hideLoader();
        alert("Unexpected error");
    }
}
</script>

</body>
</html>
